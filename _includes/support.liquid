{% assign bmc = site.buymeacoffee %}
{% assign sp = site.sponsor %}
{% assign vietnam_qr = site.vietnam_qr %}

<div>
  <div class="support-buttons" style="margin-top:1.5rem; display:flex; gap:1rem; justify-content:center; flex-wrap:wrap;">
    {% if bmc and bmc.enabled and bmc.username %}
      {% if bmc.mode == 'floating' %}
        <script
          data-name="BMC-Widget"
          data-cfasync="false"
          src="https://cdnjs.buymeacoffee.com/1.0.0/widget.prod.min.js"
          data-id="{{ bmc.username | escape }}"
          data-description="{{ bmc.description | default: 'Support me on Buy me a coffee!' | escape }}"
          data-message="{{ bmc.message | escape }}"
          data-color="{{ bmc.color | default: '#FF5F5F' }}"
          data-position="{{ bmc.position | default: 'Right' }}"
          data-x_margin="{{ bmc.x_margin | default: 18 }}"
          data-y_margin="{{ bmc.y_margin | default: 18 }}"
        ></script>
      {% else %}
        <a href="https://www.buymeacoffee.com/{{ bmc.username | escape }}" target="_blank" rel="noopener">
          <img
            src="{{ bmc.button_image | default: 'https://cdn.buymeacoffee.com/buttons/v2/default-blue.png' }}"
            alt="{{ bmc.text | default: 'Buy me a coffee' }}"
            style="height: {{ bmc.button_height | default: 45 }}px; width: {{ bmc.button_width | default: 162 }}px;"
          >
        </a>
      {% endif %}
    {% endif %}

    {%- if sp and sp.enabled and sp.github -%}
      <iframe
        src="https://github.com/sponsors/{{ sp.github }}/button"
        title="Sponsor {{ sp.github }}"
        height="32"
        width="114"
        style="border: 0; border-radius: 6px;"
      >
      </iframe>
    {%- endif -%}
  </div>

  {% if vietnam_qr.enabled == true %}
    <!-- Vietnam-only -->
    <div id="vn-support" style="display:none; margin-top:20px;">
      <p>ðŸ‡»ðŸ‡³ á»¦ng há»™ tÃ´i táº¡i Viá»‡t Nam</p>
      <p>QuÃ©t mÃ£ QR Ä‘á»ƒ á»§ng há»™ tÃ´i:</p>
      <div class="d-flex justify-content-center flex-wrap" style="gap:1rem;">
        <div>
          {%
            include figure.liquid
            loading="lazy"
            path="/assets/img/donation_viet_qr.png"
            height="200"
            width="auto"
            class="z-depth-1 rounded"
            zoomable=false
            alt="VietQR"
          %}
        </div>
      </div>
    </div>

    <!-- Manual toggle (fallback) -->
    {% if vietnam_qr.fallback == true %}
      <p id="fallback-vn-support" style="display:block; margin-top:10px;">
        <a href="#" onclick="showVnSupport(); this.style.display='none'; return false;">
          ðŸ‘‹ Are you in Vietnam? Click here to see local support options.
        </a>
      </p>
    {% endif %}

    <script>
      function fetchCountry() {
        return fetch('https://www.cloudflare.com/cdn-cgi/trace') // served by Cloudflare automatically
          .then((res) => res.text())
          .then((text) => {
            let match = text.match(/loc=(\w+)/);
            return match ? match[1] : null;
          })
          .catch(() => null);
      }

      function showVnSupport() {
        const vnSupport = document.getElementById('vn-support');
        const fallbackButton = document.getElementById('fallback-vn-support');

        if (vnSupport) vnSupport.style.display = 'block';
        if (fallbackButton) fallbackButton.style.display = 'none';
      }

      function isCountryCodeVN(code) {
        const isVN = code === 'VN';
        return isVN;
      }

      function detectVietnamUser() {
        fetchCountry().then((code) => {
          if (isCountryCodeVN(code)) {
            showVnSupport();
          }
        });
      }

      // Lazy run after load
      window.addEventListener('load', () => {
        if ('requestIdleCallback' in window) {
          requestIdleCallback(detectVietnamUser);
        } else {
          setTimeout(detectVietnamUser, 2000);
        }
      });
    </script>
  {% endif %}
</div>
